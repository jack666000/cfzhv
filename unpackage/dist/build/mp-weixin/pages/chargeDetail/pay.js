(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chargeDetail/pay"],{"496e":function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return a}));var a={uniPopup:function(){return n.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(n.bind(null,"1081"))}},r=function(){var e=this.$createElement;this._self._c},o=[]},7891:function(e,t,n){"use strict";var a=n("cccc"),r=n.n(a);r.a},cccc:function(e,t,n){},d5a2:function(e,t,n){"use strict";n.r(t);var a=n("d7f2"),r=n.n(a);for(var o in a)["default"].indexOf(o)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(o);t["default"]=r.a},d7f2:function(e,t,n){"use strict";(function(e,a){var r=n("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=r(n("2eee")),c=r(n("c973")),i=n("6d37"),s=r(n("2d69")),u=n("8981");function l(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return f(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return f(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,c=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){i=!0,o=e},f:function(){try{c||null==n.return||n.return()}finally{if(i)throw o}}}}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var d=null,g={data:function(){return{show:!1,remindShow:!1,linkFailedShow:!1,paymentSuccessfulShow:!1,faultShow:!1,chargingStationId:"",chargingRules:[],chargingStationInfo:{},chargeNum:"",balance:0,chargingPort:{},times:60,isLogin:!1,code:"",power:"",chargeInfo:{},rulesList:[]}},onLoad:function(t){console.log(t);var n=e.getStorageSync("token");t.chargeId&&(this.chargeId=t.chargeId,n&&(this.getChargingInfo(),this.fenchRulesData()))},onShow:function(){this.getCode();var t=e.getStorageSync("token");t?(this.getBalance(),this.isLogin=!0):this.isLogin=!1},onUnload:function(){clearInterval(d)},computed:{currentPrice:function(){return this.rulesList.filter((function(e){return e.status}))[0]}},methods:{showPircePopup:function(){this.$refs.pircePopup.open("bottom")},getChargingInfo:function(){var t=this;return(0,c.default)(o.default.mark((function n(){var a;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,(0,i.cfChargingStationGetInfoById)({id:t.chargeId});case 2:a=n.sent,console.log(111,a),10002===a.code&&(t.chargeInfo=a.data,e.setNavigationBarTitle({title:a.data.stationName}));case 5:case"end":return n.stop()}}),n)})))()},fenchRulesData:function(){var t=this;return(0,c.default)(o.default.mark((function n(){var a,r,c,s;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,(0,i.getChargeRulesListByQuery)({chargingStationId:t.chargeId,page:1,size:100});case 2:a=n.sent,r=a.data,c=a.code,s=a.message,console.log(r,c),10002==c?t.getCurrentTimePrice(r):e.showToast({title:s,icon:"none"});case 8:case"end":return n.stop()}}),n)})))()},getExpectedChargingTime:function(e){return(this.chargeNum/e/this.power*1e3).toFixed(2)+"小时"},getCode:function(){var e=this;a.login({success:function(t){console.log(t),e.code=t.code}})},getCurrentTimePrice:function(e){var t,n=e,a=(0,s.default)().valueOf()-(0,s.default)().startOf("day").valueOf(),r=l(n);try{for(r.s();!(t=r.n()).done;){var o=t.value;a>o.startTime&&a<o.endTime?(console.log(o),o.status=1):o.status=0}}catch(c){r.e(c)}finally{r.f()}this.rulesList=n},wxLogin:function(){var t=this,n=this;e.showLoading({title:"请稍等"}),e.getUserProfile({desc:"保存用户数据",success:function(){var a=(0,c.default)(o.default.mark((function a(r){var c,s,l,f;return o.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return c=r.iv,s=r.encryptedData,l={iv:c,code:t.code,loginType:"mp",encryptedData:s,appid:u.wxAppid},a.next=4,(0,i.wxMpLogin)(l);case 4:f=a.sent,console.log("登陆个人信息",f),e.hideLoading(),24017===f.code?(e.showToast({title:"code失效 请重试一次",icon:"none"}),n.getCode()):10002==f.code?(t.isLogin=!0,e.setStorageSync("user",f.data),e.setStorageSync("token",f.token.access_token),t.getBalance(),t.fenchRulesData(),t.getChargingInfo()):t.$u.toast("登陆出错");case 8:case"end":return a.stop()}}),a)})));return function(e){return a.apply(this,arguments)}}()})},initNullMessagePojo:function(){var t={type:"create_link",cfUserMessage:{id:"",fromUid:"",toUid:"",groupId:"",status:0,contents:"",type:0,client:"",ip:"",createTime:0,receiveTime:0},ext:"",token:e.getStorageSync("token")};return t},onPay:function(){var t=this;return(0,c.default)(o.default.mark((function n(){var a;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t.chargeNum){n.next=2;break}return n.abrupt("return");case 2:if(!(t.chargeNum>t.balance)){n.next=6;break}e.showToast({title:"余额不足 请先充值",icon:"none"}),n.next=12;break;case 6:return n.next=8,t.$u.api.startCharging({chargingFee:t.chargeNum,chargingPort:t.chargingPort.portNumber,id:t.chargingPort.chargingDeviceId});case 8:a=n.sent,console.log("开始充电信息",a),10002===a.code?(e.setStorageSync("charingId",a.data.id),d=setInterval((function(){0===t.times&&(clearInterval(d),t.paymentSuccessfulShow=!1,t.linkFailedShow=!0),t.times=t.times-1}),1e3),t.paymentSuccessfulShow=!0):e.showToast({title:a.message,icon:"none"}),10002==a.code?t.getWsUrl():e.showToast({title:a.message,icon:"none"});case 12:case"end":return n.stop()}}),n)})))()},getWsUrl:function(){var t=this;return(0,c.default)(o.default.mark((function n(){var a,r,c,i;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,t.$u.api.getMinChatLinkCountsServiceIp();case 2:a=n.sent,r=a.data,c=a.code,i=a.message,console.log(r),10002!==c?e.showToast({title:i,icon:"none"}):t.initWs(r);case 8:case"end":return n.stop()}}),n)})))()},initWs:function(t){var n=this;e.connectSocket({url:"wss://wss.cfeng.wang/".concat(t)}),e.onSocketOpen((function(e){!0,console.log("WebSocket连接已打开！"),a()})),e.onSocketError((function(e){console.log(e)})),e.onSocketMessage((function(t){console.log("收到服务器内容："+t.data);var a=JSON.parse(t.data).cfUserMessage;a.contents=JSON.parse(a.contents),console.log(a),2===a.contents.chargingStatus&&(console.log("已启动"),e.closeSocket(),e.navigateTo({url:"../charging/index?datas="+JSON.stringify(n.chargingPort)}))}));var a=function(){var t=n.initNullMessagePojo();t.type="create_link",e.sendSocketMessage({data:JSON.stringify(t)}),setInterval((function(){var t=n.initNullMessagePojo();t.type="heartbeat_check",e.sendSocketMessage({data:JSON.stringify(t)})}),500)}},getBalance:function(){var e=this;return(0,c.default)(o.default.mark((function t(){var n,a,r;return o.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,(0,i.cfAccountGet)();case 2:n=t.sent,a=n.data,r=n.code,10002==r&&(console.log(a),e.balance=a[0].balance);case 6:case"end":return t.stop()}}),t)})))()},getTimeText:function(e){return null!=e?(0,s.default)((0,s.default)().startOf("month").valueOf()+e).format("HH:mm"):"-"},getInfo:function(){var e=this;return(0,c.default)(o.default.mark((function t(){var n;return o.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$u.api.searchChargingStation({id:e.chargingStationId});case 2:n=t.sent,console.log("充电站信息",n),10002===n.code&&(e.chargingStationInfo=n.data[0]);case 5:case"end":return t.stop()}}),t)})))()},intoRecharge:function(){e.navigateTo({url:"../../../pages/my/myWallet/recharge"})}}};t.default=g}).call(this,n("543d")["default"],n("bc2e")["default"])},e0b4:function(e,t,n){"use strict";n.r(t);var a=n("496e"),r=n("d5a2");for(var o in r)["default"].indexOf(o)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(o);n("7891");var c=n("f0c5"),i=Object(c["a"])(r["default"],a["b"],a["c"],!1,null,null,null,!1,a["a"],void 0);t["default"]=i.exports},e6ac:function(e,t,n){"use strict";(function(e,t){var a=n("4ea4");n("c530");a(n("66fd"));var r=a(n("e0b4"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(r.default)}).call(this,n("bc2e")["default"],n("543d")["createPage"])}},[["e6ac","common/runtime","common/vendor"]]]);